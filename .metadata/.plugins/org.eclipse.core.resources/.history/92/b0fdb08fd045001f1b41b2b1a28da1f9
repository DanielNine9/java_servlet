package servlets;

import java.io.IOException;
import java.util.Map;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.beanutils.BeanUtils;

import bean.User;
import dao.UserDAO;

@WebServlet({ "/auth/login", "/auth/register", "/auth/home" })
public class AuthServlet extends HttpServlet {
	@Override
	protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {

		String uri = req.getRequestURI();
		String method = req.getMethod();
		if ("get".equalsIgnoreCase(method)) {
			if (uri.contains("login")) {
				req.setAttribute("view", "/login.jsp");
			} else if (uri.contains("register")) {
				req.setAttribute("view", "/register.jsp");
			} else if (uri.contains("home")) {
				req.setAttribute("view", "/home.jsp");
			}
			req.getRequestDispatcher("/index.jsp").forward(req, resp);
		} else {
			if (uri.contains("login")) {
				req.setAttribute("view", "/login.jsp");
			} else if (uri.contains("register")) {
				handleRegister(req, resp);
			}

		}

	}
	
	public void handleCreate(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		UserDAO dao = new UserDAO();
		User user = new User();
		try {
			String id = req.getParameter("id");
			user = dao.findById(id);

			if (user == null) {
				req.setAttribute("message", "Username chưa đăng ký với hệ thống.");
				req.setAttribute("view", "/login.jsp");
				req.getRequestDispatcher("/index.jsp").forward(req, resp);
				return;
			}
			
			String password = req.getParameter("password");
			
			if(!password.equals(user.getPassword())) {
				req.setAttribute("message", "Tài khoản hoặc mật khẩu không chính xác.");
				req.setAttribute("view", "/login.jsp");
				req.getRequestDispatcher("/index.jsp").forward(req, resp);
				return;
			}

			
		} catch (Exception e) {
			req.setAttribute("message", "Đăng ký thất bại");
			req.setAttribute("view", "/register.jsp");
		}
		req.getRequestDispatcher("/index.jsp").forward(req, resp);
	}

	public void handleRegister(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		UserDAO dao = new UserDAO();
		User user = new User();
		try {
			String id = req.getParameter("id");
			user = dao.findById(id);

			if (user != null) {
				req.setAttribute("message", "Username đã tồn tại.");
				req.setAttribute("view", "/register.jsp");
				req.getRequestDispatcher("/index.jsp").forward(req, resp);
				return;
			}
			
			String password = req.getParameter("password");
			String confirm = req.getParameter("confirmPassword");
			
			if(!password.equals(confirm)) {
				req.setAttribute("message", "Mật khẩu và xác nhận mật khẩu phải trùng khớp.");
				req.setAttribute("view", "/register.jsp");
				req.getRequestDispatcher("/index.jsp").forward(req, resp);
				return;
				
			}

			user = new User();

			Map<String, String[]> parameterMap = req.getParameterMap();
			for (String paramName : parameterMap.keySet()) {
				String[] paramValues = parameterMap.get(paramName);
				for (String paramValue : paramValues) {

					System.out.println(paramName + ": " + paramValue);
					if (paramValue == "") {
						req.setAttribute("message", "Vui lòng nhập đầy đủ tất cả các trường");
						req.setAttribute("form", null);
						req.setAttribute("items", dao.findAll());
						req.getRequestDispatcher("/index.jsp").forward(req, resp);
						return;
					}
				}
			}

			BeanUtils.populate(user, req.getParameterMap());

			User createdUser = dao.create(user);

			if (createdUser != null) {
				user = null;
				req.setAttribute("success", "Đăng ký thành công");
				req.setAttribute("view", "/login.jsp");
			} else {
				req.setAttribute("message", "Đăng ký thất bại");
				req.setAttribute("view", "/register.jsp");
			}
		} catch (Exception e) {
			req.setAttribute("message", "Đăng ký thất bại");
			req.setAttribute("view", "/register.jsp");
		}
		req.getRequestDispatcher("/index.jsp").forward(req, resp);
	}
}
